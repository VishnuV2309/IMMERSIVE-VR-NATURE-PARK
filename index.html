<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title> IMMERSIVE-VR-NATURE-PARK </title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <script>
      // 1. SOUND MANAGER (Fixed to stop previous sounds)
      AFRAME.registerComponent('play-sound-on-click', {
        schema: { src: { type: 'string' } },
        init: function () {
          this.el.addEventListener('click', (evt) => {
            evt.stopPropagation(); 
            const soundSource = document.querySelector(this.data.src);
            if (soundSource && soundSource.components.sound) {
              // Stop sound first to restart it (unless it's a continuous loop like fire)
              if (!soundSource.getAttribute('sound').loop) {
                 soundSource.components.sound.stopSound();
              }
              soundSource.components.sound.playSound();
            }
          });
        }
      });

      // 2. MOVEMENT
      AFRAME.registerComponent('teleport-on-click', {
        init: function () {
          this.el.addEventListener('click', (evt) => {
            const hit = evt.detail.intersection;
            if (!hit) return;
            const rig = document.querySelector('#rig');
            rig.setAttribute('position', {
              x: hit.point.x,
              y: rig.getAttribute('position').y,
              z: hit.point.z
            });
          });
        }
      });

      // 3. ANIMATION
      AFRAME.registerComponent('sway', {
        schema: { amp: { default: 3 }, speed: { default: 1 } },
        tick: function (t) {
          const deg = Math.sin((t / 1000) * this.data.speed) * this.data.amp;
          this.el.object3D.rotation.z = (deg * Math.PI) / 180;
        }
      });

      // 4. GENERATOR
      AFRAME.registerComponent('tree-field', {
        schema: { count: { default: 22 }, radius: { default: 32 } },
        init: function () {
          const scene = this.el;
          for (let i = 0; i < this.data.count; i++) {
            const angle = Math.random() * Math.PI * 2;
            const dist = this.data.radius * (0.4 + Math.random() * 0.6);
            const x = Math.cos(angle) * dist;
            const z = -Math.abs(Math.sin(angle) * dist);
            if (Math.sqrt(x*x + z*z) < 6) continue; // Keep clear of center

            const tree = document.createElement('a-entity');
            tree.setAttribute('position', `${x} 0 ${z}`);
            tree.setAttribute('sway', `amp:${1.5 + Math.random() * 2}; speed:${0.5 + Math.random()}`);
            tree.setAttribute('play-sound-on-click', 'src: #rustleSound');
            
            // Add clickable class to visual parts
            const trunk = document.createElement('a-cylinder');
            trunk.setAttribute('position', '0 1 0');
            trunk.setAttribute('radius', 0.25 + Math.random() * 0.15);
            trunk.setAttribute('height', 1.8 + Math.random() * 0.6);
            trunk.setAttribute('color', '#5a3b1e');
            trunk.setAttribute('class', 'clickable'); 

            const canopy = document.createElement('a-sphere');
            canopy.setAttribute('position', '0 2.2 0');
            canopy.setAttribute('radius', 1.2 + Math.random() * 0.5);
            canopy.setAttribute('color', '#2b7a37');
            canopy.setAttribute('class', 'clickable'); 

            const canopy2 = document.createElement('a-sphere');
            canopy2.setAttribute('position', `${-0.6 + Math.random() * 1.2} 2.0 ${-0.4 + Math.random() * 0.8}`);
            canopy2.setAttribute('radius', 0.9 + Math.random() * 0.4);
            canopy2.setAttribute('color', '#2f8a43');
            canopy2.setAttribute('class', 'clickable'); 

            tree.appendChild(trunk);
            tree.appendChild(canopy);
            tree.appendChild(canopy2);
            scene.appendChild(tree);
          }
        }
      });

      // 5. STARTUP HELPER
      AFRAME.registerComponent('start-sound-on-click', {
        init: function () {
          const sound = this.el.components.sound;
          if (!sound) return;
          let started = false;
          const start = () => {
            if (started) return;
            started = true;
            // Important: Resume context for Chrome browser support
            if (AFRAME.scenes[0].audioListener.context.state === 'suspended') {
                AFRAME.scenes[0].audioListener.context.resume();
            }
            sound.playSound();
            const hint = document.querySelector('#soundHint');
            if (hint) hint.setAttribute('visible', false);
            window.removeEventListener('click', start);
          };
          window.addEventListener('click', start);
        }
      });
    </script>
  </head>

  <body>
    <a-scene tree-field="count: 30; radius: 35">
      
      <a-entity id="splashSound" sound="src: url(splash.mp3); volume: 4; positional: false; poolSize: 5"></a-entity> 
      <a-entity id="woodSound"   sound="src: url(wood.mp3);   volume: 6; positional: false; poolSize: 5"></a-entity>
      <a-entity id="rustleSound" sound="src: url(leaves.mp3); volume: 4; positional: false; poolSize: 5"></a-entity>
      <a-entity id="clickSound"  sound="src: url(click.mp3);  volume: 2; positional: false; poolSize: 5"></a-entity>
      <a-entity id="quackSound"  sound="src: url(quack.mp3);  volume: 5; positional: false; poolSize: 5"></a-entity>
      <a-entity id="fireSound"   sound="src: url(fire.mp3);   volume: 8; loop: true; positional: false"></a-entity>
      <a-entity id="rabbitSound" sound="src: url(rabbit.mp3); volume: 5; positional: false; poolSize: 3"></a-entity>
      <a-entity id="deerSound"   sound="src: url(deer.mp3);   volume: 6; positional: false; poolSize: 3"></a-entity>

      <a-entity id="birdSound" sound="src: url(birds.mp3); loop: true; volume: 3; positional: false" start-sound-on-click></a-entity>
      <a-entity id="ambience"  sound="src: url(https://cdn.aframe.io/basic-guide/audio/backgroundnoise.wav); loop: true; volume: 1.5; positional: false" start-sound-on-click></a-entity>

      <a-sky color="#ffb199"></a-sky>
      <a-circle position="-4 8 -20" radius="1.7" color="#ffe066" material="emissive:#ffe066; emissiveIntensity:0.9"></a-circle>
      <a-text id="soundHint" value="CLICK GROUND TO START AUDIO" position="0 2 -3" color="#ffffff" width="4" align="center"></a-text>
      <a-circle id="ground" radius="40" rotation="-90 0 0" color="#1b7d2c" class="clickable" teleport-on-click></a-circle>

      <a-circle radius="4" rotation="-90 0 0" position="0 0.1 -5" color="#7dd9ff" class="clickable" play-sound-on-click="src: #splashSound"></a-circle>
      <a-box position="0 0.5 -6.5" depth="1.5" height="0.3" width="3" color="#91552b" rotation="0 180 0" class="clickable" play-sound-on-click="src: #woodSound"></a-box>

      <a-entity position="1.5 0.3 -5" rotation="0 -30 0" play-sound-on-click="src: #quackSound" animation="property: position; dir: alternate; to: 1.5 0.35 -5; dur: 1500; loop: true; easing: easeInOutSine">
          <a-sphere radius="0.25" color="#ffdb58" scale="1 0.8 1.2" class="clickable"></a-sphere>
          <a-sphere position="0 0.25 0.3" radius="0.15" color="#ffdb58" class="clickable"></a-sphere>
          <a-cone position="0 0.25 0.45" rotation="-90 0 0" radius-bottom="0.08" height="0.15" color="orange"></a-cone>
      </a-entity>
      <a-entity position="-1 0.3 -4" rotation="0 60 0" play-sound-on-click="src: #quackSound" animation="property: position; dir: alternate; to: -1 0.35 -4; dur: 1700; loop: true; easing: easeInOutSine">
          <a-sphere radius="0.25" color="#ffdb58" scale="1 0.8 1.2" class="clickable"></a-sphere>
          <a-sphere position="0 0.25 0.3" radius="0.15" color="#ffdb58" class="clickable"></a-sphere>
          <a-cone position="0 0.25 0.45" rotation="-90 0 0" radius-bottom="0.08" height="0.15" color="orange"></a-cone>
      </a-entity>

      <a-entity position="2 0.1 -7.5" play-sound-on-click="src: #fireSound">
          <a-cylinder rotation="90 45 0" radius="0.08" height="1" color="#5a3b1e"></a-cylinder>
          <a-cylinder rotation="90 -45 0" radius="0.08" height="1" color="#5a3b1e"></a-cylinder>
          <a-sphere position="0 0.3 0" radius="0.3" color="red" material="emissive:red; emissiveIntensity:0.5" class="clickable" animation="property: material.emissiveIntensity; to: 1; dir: alternate; dur: 500; loop: true"></a-sphere>
          <a-sphere position="0 0.5 0" radius="0.2" color="orange" material="emissive:orange; emissiveIntensity:0.6" class="clickable" animation="property: material.emissiveIntensity; to: 1.2; dir: alternate; dur: 400; loop: true"></a-sphere>
          <a-entity light="type: point; intensity: 1.5; distance: 4; color: #ff6600" position="0 0.5 0" animation="property: light.intensity; to: 2.5; dir: alternate; dur: 200; loop: true"></a-entity>
      </a-entity>

      <a-entity position="-3 0.2 -3" rotation="0 45 0" play-sound-on-click="src: #rabbitSound"
                animation="property: position; dir: alternate; to: -3 0.25 -3; dur: 800; loop: true; easing: easeOutQuad">
          <a-sphere radius="0.2" scale="1 0.8 1.5" color="#f0f0f0" class="clickable"></a-sphere>
          <a-sphere position="0 0.25 0.4" radius="0.12" color="#f0f0f0" class="clickable"></a-sphere>
          <a-sphere position="0.08 0.55 0.35" radius="0.05" scale="0.5 2.5 0.5" color="#f0f0f0" rotation="-20 0 0"></a-sphere>
          <a-sphere position="-0.08 0.55 0.35" radius="0.05" scale="0.5 2.5 0.5" color="#f0f0f0" rotation="-20 0 0"></a-sphere>
          <a-sphere position="0 0.1 -0.35" radius="0.08" color="#f0f0f0"></a-sphere>
      </a-entity>

      <a-entity position="5 0.8 -8" rotation="0 -20 0" play-sound-on-click="src: #deerSound"
                animation="property: scale; dir: alternate; to: 1.02 1.02 1.02; dur: 2500; loop: true; easing: easeInOutSine">
          <a-box scale="0.8 0.8 1.5" color="#8b5a2b" class="clickable"></a-box>
          <a-cylinder position="-0.3 -0.6 0.6" radius="0.1" height="0.8" color="#8b5a2b"></a-cylinder>
          <a-cylinder position="0.3 -0.6 0.6" radius="0.1" height="0.8" color="#8b5a2b"></a-cylinder>
          <a-cylinder position="-0.3 -0.6 -0.6" radius="0.1" height="0.8" color="#8b5a2b"></a-cylinder>
          <a-cylinder position="0.3 -0.6 -0.6" radius="0.1" height="0.8" color="#8b5a2b"></a-cylinder>
          <a-cylinder position="0 0.5 0.6" rotation="30 0 0" radius="0.18" height="0.7" color="#8b5a2b" class="clickable"></a-cylinder>
          <a-box position="0 0.9 0.9" scale="0.35 0.4 0.6" color="#8b5a2b" class="clickable"></a-box>
          <a-cylinder position="0.15 1.2 0.85" radius="0.03" height="0.5" color="#d2b48c" rotation="0 0 -20"></a-cylinder>
          <a-cylinder position="-0.15 1.2 0.85" radius="0.03" height="0.5" color="#d2b48c" rotation="0 0 20"></a-cylinder>
      </a-entity>


      <a-entity position="-4 0 -3" sway="amp:5; speed:1.2">
         <a-cylinder position="0 0.35 0" radius="0.03" height="0.7" color="#2d8a3b"></a-cylinder>
         <a-sphere   position="0 0.8 0" radius="0.13" color="#ff4b7d"></a-sphere>
      </a-entity>
      <a-entity position="-0.8 0.4 -4.3">
        <a-sphere radius="0.12" color="#ff8ce6" material="emissive:#ff8ce6; emissiveIntensity:0.8" animation="property: position; dir: alternate; to: -0.8 0.7 -4.3; dur: 2000; loop: true"></a-sphere>
      </a-entity>
      <a-entity position="-6 8 -10" animation="property: position; to: 10 8 5; dur: 15000; loop: true">
        <a-sphere radius="0.1" color="#ffffff"></a-sphere>
        <a-plane width="0.3" height="0.05" color="#f2f2f2" rotation="0 0 15" position="0.15 0 0"></a-plane>
        <a-plane width="0.3" height="0.05" color="#f2f2f2" rotation="0 0 -15" position="-0.15 0 0"></a-plane>
      </a-entity>

      <a-entity id="rig" position="0 1.6 5">
        <a-entity camera look-controls wasd-controls>
            <a-cursor id="cursor" color="white" fuse="false" raycaster="objects: .clickable"
                      animation__mouseenter="property: scale; startEvents: mouseenter; dur: 100; to: 1.5 1.5 1.5"
                      animation__mouseleave="property: scale; startEvents: mouseleave; dur: 100; to: 1 1 1"></a-cursor>
        </a-entity>
      </a-entity>

      <a-entity light="type: ambient; intensity:0.6; color:#ffe0c2"></a-entity>
      <a-entity light="type: directional; intensity:0.5; color:#ffd3a1" position="-1 3 2"></a-entity>

    </a-scene>
  </body>
</html>